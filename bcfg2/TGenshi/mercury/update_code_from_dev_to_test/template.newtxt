#!/bin/bash

# exit on any error or any pipeline command error
set -e
set -o pipefail

. /etc/mercury/update_scripts_config

echo "Starting the update_code_from_dev_to_test script"

# --headless assumes this script is not being run by hand (but rather in hudson or through another script)
if [[ "--headless" != $$1 ]]; then
    echo "CONFIRM: update code from $SVN_ROOT (dev) to $TEST_WEBROOT (test) (y/n)"
    
    read ANSWER
    echo ""
    if [[ ${ANSWER} != "y" ]]; then
	echo "Cancelling....."
	exit 1
    fi
    echo "Creating a log of the output of this script at /etc/mercury/logs/update_code_from_dev_to_test.log"
    exec &> /etc/mercury/logs/update_code_from_dev_to_test.log
fi

echo "*Updating test*"

chmod +w $TEST_WEBROOT/sites/$TEST_SITE_DIR/settings.php
svn update --username $SVN_USER --password $SVN_PASS $TEST_WEBROOT
sed -i "s|^\$db_url = .*|\$db_url = 'mysqli:\\/\\/$TEST_DB_USERNAME:$TEST_DB_PASSWORD@localhost\\/$TEST_DB';|" $TEST_WEBROOT/sites/$TEST_SITE_DIR/settings.php
chmod -w $TEST_WEBROOT/sites/$TEST_SITE_DIR/settings.php

echo "*Test code updated*"
