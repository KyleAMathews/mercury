#!/bin/bash

# exit on any error or any pipeline command error
set -e
set -o pipefail

. /etc/mercury/update_scripts_config

echo "Starting the update_db_from_live_to_test script"

# --headless assumes this script is not being run by hand (but rather in hudson or through another script)
if [[ "--headless" != $$1 ]]; then
    echo "CONFIRM: update db from $LIVE_WEBROOT (live) to $TEST_WEBROOT (test)"
    echo -n "Continue (y/n)"

    read ANSWER
    echo ""
    if [[ ${ANSWER} != "y" ]]; then
	echo "Cancelling....."
	exit 1
    fi
    echo "Creating a log of the output of this script at /etc/mercury/logs/update_db_from_live_to_test.log"
    exec &> /etc/mercury/logs/update_db_from_live_to_test.log
fi

echo "*Backing up test db*"

mysqldump -u $TEST_DB_USERNAME -p$TEST_DB_PASSWORD $TEST_DB > $BACKUP_DIR/test.$DATE.sql

echo "*Updating test db*"

mysqldump -u $LIVE_DB_USERNAME -p$LIVE_DB_PASSWORD $LIVE_DB > $BACKUP_DIR/live.$DATE.sql
echo "drop database $TEST_DB" | mysql -u $TEST_DB_USERNAME -p$TEST_DB_PASSWORD 
echo "create database $TEST_DB" | mysql -u $TEST_DB_USERNAME -p$TEST_DB_PASSWORD 
mysql -u $TEST_DB_USERNAME -p$TEST_DB_PASSWORD -D $TEST_DB < $BACKUP_DIR/live.$DATE.sql

echo "*test db updated*"
