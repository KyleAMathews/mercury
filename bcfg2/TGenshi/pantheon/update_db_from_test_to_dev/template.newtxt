#!/bin/bash

# exit on any error or any pipeline command error
set -e
set -o pipefail

. /etc/pantheon/update_scripts_config

echo "Starting the update_db_from_test_to_dev script"

# --headless assumes this script is not being run by hand (but rather in hudson or through another script)
if [[ "--headless" != $$$$1 ]]; then
    echo "CONFIRM: update db from $$TEST_WEBROOT (test) to $$DEV_WEBROOT (dev)"
    echo -n "Continue (y/n)"

    read ANSWER
    echo ""
    if [[ $${ANSWER} != "y" ]]; then
	echo "Cancelling....."
	exit 1
    fi
    echo "Creating a log of the output of this script at /etc/pantheon/logs/update_db_from_test_to_dev.log"
    exec &> /etc/pantheon/logs/update_db_from_test_to_dev.log
fi

echo "*Backing up dev db*"

mysqldump -u $$DEV_DB_USERNAME -p$$DEV_DB_PASSWORD $$DEV_DB > $$BACKUP_DIR/dev.$$DATE.sql

echo "*Updating dev db*"

mysqldump -u $$TEST_DB_USERNAME -p$$TEST_DB_PASSWORD $$TEST_DB > $$BACKUP_DIR/test.$$DATE.sql
echo "drop database $$DEV_DB" | mysql -u $$DEV_DB_USERNAME -p$$DEV_DB_PASSWORD 
echo "create database $$DEV_DB" | mysql -u $$DEV_DB_USERNAME -p$$DEV_DB_PASSWORD 
mysql -u $$DEV_DB_USERNAME -p$$DEV_DB_PASSWORD -D $$DEV_DB < $$BACKUP_DIR/test.$$DATE.sql

echo "*dev db updated*"
