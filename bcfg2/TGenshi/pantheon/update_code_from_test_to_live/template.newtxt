#!/bin/bash

# exit on any error or any pipeline command error
set -e
set -o pipefail

. /etc/pantheon/update_scripts_config

echo "Starting the update_code_from_test_to_live script"

# --headless assumes this script is not being run by hand (but rather in hudson or through another script)
if [[ "--headless" != $$$$1 ]]; then
    echo "CONFIRM: push code from $$TEST_WEBROOT (test) to $$LIVE_WEBROOT (live) (y/n)"
    
    read ANSWER
    echo ""
    if [[ $${ANSWER} != "y" ]]; then
	echo "Cancelling....."
	exit 1
    fi
    echo "Creating a log of the output of this script at /etc/pantheon/logs/update_code_from_test_to_live.log"
    exec &> /etc/pantheon/logs/update_code_from_test_to_live.log
fi

if svn git $$TEST_WEBROOT | grep -q -v "?"; then 
    echo "*WARNING*Test is OUT OF SYNC with SVN. You should probably fix this before proceeding!  Proceed anyway? (Y/N)"
    read ANSWER
    echo ""
    if [[ $${ANSWER} != "y" ]]; then
        echo "Cancelling....."
        exit 1
    fi
fi

echo "*Backing up current live codebase to $$BACKUP_DIR/www-last*"

mkdir -p $$BACKUP_DIR
rm -rf BACKUP_DIR/www-last
rsync -a $$LIVE_WEBROOT $$BACKUP_DIR/www-last

echo "*Backing up Current database to $$BACKUP_DIR/live.$$DATE.sq (for good measure)*"

mysqldump -u $$LIVE_DB_USERNAME -p$$LIVE_DB_PASSWORD $$LIVE_DB > $$BACKUP_DIR/live.$$DATE.sql

echo "*Exporting Stable Codebase"

git archive master | tar -x -C $$TMP_DIR/code_push/

echo "*Synchronizing*"

rsync -av --exclude=settings.php $$TMP_DIR/code_push/ $$LIVE_WEBROOT

echo "*Code Push Complete!*"

rm -Rf $$TMP_DIR/code_push
